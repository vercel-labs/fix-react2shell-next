/**
 * CVE-2025-55183: Source Code Exposure in React Server Components
 * @see https://vercel.com/kb/bulletin/cve-2025-55184-and-cve-2025-55183
 *
 * Affected versions:
 * - Next.js 15.0.x before 15.0.6
 * - Next.js 15.1.x before 15.1.10
 * - Next.js 15.2.x before 15.2.7
 * - Next.js 15.3.x before 15.3.7
 * - Next.js 15.4.x before 15.4.9
 * - Next.js 15.5.x before 15.5.8
 * - Next.js 15.x canary before 15.6.0-canary.59
 * - Next.js 16.0.x before 16.0.9
 * - Next.js 16.x canary before 16.1.0-canary.17
 * - React RSC packages 19.0.0 through 19.2.1
 *
 * Note: Next.js 13.x and 14.x are NOT affected by this CVE.
 * Note: Next.js Pages Router applications are not affected.
 */

const { parseVersion, compareVersions, cleanVersion } = require('../utils/version');

// Patched versions for Next.js 15.x and 16.x stable releases
const NEXT_PATCHED_VERSIONS = {
  '15.0': '15.0.6',
  '15.1': '15.1.10',
  '15.2': '15.2.7',
  '15.3': '15.3.7',
  '15.4': '15.4.9',
  '15.5': '15.5.8',
  '16.0': '16.0.9',
};

// Patched canary versions
const NEXT_CANARY_PATCHES = {
  15: '15.6.0-canary.59',
  16: '16.1.0-canary.17',
};

// React RSC vulnerable versions (19.0.0 through 19.2.1)
const REACT_RSC_VULNERABLE_VERSIONS = [
  '19.0.0', '19.0.1',
  '19.1.0', '19.1.1', '19.1.2',
  '19.2.0', '19.2.1',
];

// React RSC patched versions
const REACT_RSC_PATCHES = {
  '19.0.0': '19.0.2',
  '19.0.1': '19.0.2',
  '19.1.0': '19.1.3',
  '19.1.1': '19.1.3',
  '19.1.2': '19.1.3',
  '19.2.0': '19.2.2',
  '19.2.1': '19.2.2',
};

const REACT_RSC_PACKAGES = [
  'react-server-dom-webpack',
  'react-server-dom-parcel',
  'react-server-dom-turbopack',
];

function isNextVulnerable(version) {
  const parsed = parseVersion(version);
  if (!parsed) return { vulnerable: false, reason: 'unparseable' };

  const { major, minor, raw, isCanary } = parsed;

  // Only 15.x and 16.x are affected by this CVE
  if (major < 15) {
    return { vulnerable: false, reason: 'version-not-affected' };
  }

  if (major > 16) {
    return { vulnerable: false, reason: 'future-version' };
  }

  // Next.js 15.x
  if (major === 15) {
    if (isCanary) {
      if (compareVersions(raw, '15.6.0-canary.59') >= 0) {
        return { vulnerable: false, reason: 'patched-canary' };
      }
      return { vulnerable: true, reason: '15.x-canary' };
    }

    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (!patchedVersion) {
      return { vulnerable: minor < 6, reason: minor < 6 ? 'unknown-minor-assume-vulnerable' : 'unknown-minor-assume-safe' };
    }

    if (compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }
    return { vulnerable: false, reason: 'patched' };
  }

  // Next.js 16.x
  if (major === 16) {
    if (isCanary) {
      if (compareVersions(raw, '16.1.0-canary.17') >= 0) {
        return { vulnerable: false, reason: 'patched-canary' };
      }
      return { vulnerable: true, reason: '16.x-canary' };
    }

    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (patchedVersion && compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }

    if (minor >= 1) {
      return { vulnerable: false, reason: 'patched' };
    }

    if (minor === 0 && parsed.patch < 9) {
      return { vulnerable: true, reason: 'below-16.0.9' };
    }

    return { vulnerable: false, reason: 'patched' };
  }

  return { vulnerable: false, reason: 'unknown' };
}

function isReactRscVulnerable(version) {
  const cleaned = cleanVersion(version);
  return REACT_RSC_VULNERABLE_VERSIONS.includes(cleaned);
}

function getNextPatchedVersion(version) {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const { major, minor, isCanary } = parsed;

  // Only handle 15.x and 16.x
  if (major < 15 || major > 16) return null;

  // Canary versions
  if (isCanary) {
    const canaryPatch = NEXT_CANARY_PATCHES[major];
    if (canaryPatch) {
      return { recommended: canaryPatch };
    }
  }

  // Stable versions
  const minorKey = `${major}.${minor}`;
  const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

  if (patchedVersion) {
    return { recommended: patchedVersion };
  }

  // Fallback for unknown minors
  if (major === 15) return { recommended: '15.5.8' };
  if (major === 16) return { recommended: '16.0.9' };

  return null;
}

function getReactRscPatchedVersion(version) {
  const cleaned = cleanVersion(version);
  return REACT_RSC_PATCHES[cleaned] || null;
}

module.exports = {
  // Metadata
  id: 'CVE-2025-55183',
  name: 'Source Code Exposure',
  severity: 'medium',
  description: 'Compiled Server Action source code can be exposed via malicious request',

  // Packages this CVE applies to
  packages: ['next', ...REACT_RSC_PACKAGES],

  // Check if a specific package@version is vulnerable
  isVulnerable(packageName, version) {
    if (packageName === 'next') {
      return isNextVulnerable(version);
    }
    if (REACT_RSC_PACKAGES.includes(packageName)) {
      return { vulnerable: isReactRscVulnerable(version), reason: 'rsc-version-check' };
    }
    return { vulnerable: false, reason: 'not-applicable' };
  },

  // Get the minimum version that fixes this CVE
  getPatchedVersion(packageName, version) {
    if (packageName === 'next') {
      return getNextPatchedVersion(version);
    }
    if (REACT_RSC_PACKAGES.includes(packageName)) {
      const patched = getReactRscPatchedVersion(version);
      return patched ? { recommended: patched } : null;
    }
    return null;
  },
};
