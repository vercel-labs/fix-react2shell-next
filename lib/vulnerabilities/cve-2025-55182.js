/**
 * CVE-2025-55182: React Server Components RCE
 * @see https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components
 * @see https://www.facebook.com/security/advisories/cve-2025-55182
 *
 * Affected packages:
 * - react: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-dom: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-server-dom-webpack: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-server-dom-parcel: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-server-dom-turbopack: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 *
 * Note: This CVE affects React Server Components across all bundlers.
 */

const { cleanVersion } = require('../utils/version');

// React packages vulnerable to this CVE
const REACT_VULNERABLE_VERSIONS = [
  '19.0.0', '19.1.0', '19.1.1', '19.2.0',
];

// React package patches
const REACT_PATCHES = {
  '19.0.0': '19.0.1',
  '19.1.0': '19.1.2',
  '19.1.1': '19.1.2',
  '19.2.0': '19.2.1',
};

// React Server Components packages affected by this CVE
const REACT_RSC_PACKAGES = [
  'react-server-dom-webpack',
  'react-server-dom-parcel',
  'react-server-dom-turbopack',
];

// All packages affected by this CVE
const REACT_PACKAGES = ['react', 'react-dom', ...REACT_RSC_PACKAGES];

function isReactVulnerable(version) {
  const cleaned = cleanVersion(version);
  return REACT_VULNERABLE_VERSIONS.includes(cleaned);
}

function getReactPatchedVersion(version) {
  const cleaned = cleanVersion(version);
  return REACT_PATCHES[cleaned] || null;
}

module.exports = {
  // Metadata
  id: 'CVE-2025-55182',
  name: 'React Server Components RCE',
  severity: 'critical',
  description: 'Pre-authentication remote code execution via unsafe deserialization in React Server Components',

  // Packages this CVE applies to
  packages: REACT_PACKAGES,

  // Check if a specific package@version is vulnerable
  isVulnerable(packageName, version) {
    if (REACT_PACKAGES.includes(packageName)) {
      return { vulnerable: isReactVulnerable(version), reason: 'react-version-check' };
    }
    return { vulnerable: false, reason: 'not-applicable' };
  },

  // Get the minimum version that fixes this CVE
  getPatchedVersion(packageName, version) {
    if (REACT_PACKAGES.includes(packageName)) {
      const patched = getReactPatchedVersion(version);
      return patched ? { recommended: patched } : null;
    }
    return null;
  },
};
