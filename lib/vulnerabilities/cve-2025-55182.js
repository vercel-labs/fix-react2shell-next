/**
 * CVE-2025-55182: React Server Components Vulnerability
 * @see https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components
 *
 * Affected packages:
 * - react: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-dom: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 */

const { cleanVersion } = require('../utils/version');

// Vulnerable versions and their patches for React core packages
const REACT_PATCHES = {
  '19.0.0': '19.0.1',
  '19.1.0': '19.1.2',
  '19.1.1': '19.1.2',
  '19.2.0': '19.2.1',
};

// Core React packages affected by this CVE
const REACT_CORE_PACKAGES = ['react', 'react-dom'];

function isReactVulnerable(version) {
  const cleaned = cleanVersion(version);
  return REACT_PATCHES.hasOwnProperty(cleaned);
}

function getReactPatchedVersion(version) {
  const cleaned = cleanVersion(version);
  return REACT_PATCHES[cleaned] || null;
}

module.exports = {
  // Metadata
  id: 'CVE-2025-55182',
  name: 'React Server Components RCE',
  severity: 'critical',
  description: 'Pre-authentication remote code execution via unsafe deserialization in React Server Components',

  // Packages this CVE applies to
  packages: REACT_CORE_PACKAGES,

  // Check if a specific package@version is vulnerable
  isVulnerable(packageName, version) {
    if (REACT_CORE_PACKAGES.includes(packageName)) {
      return { vulnerable: isReactVulnerable(version), reason: 'react-core-version-check' };
    }
    return { vulnerable: false, reason: 'not-applicable' };
  },

  // Get the minimum version that fixes this CVE
  getPatchedVersion(packageName, version) {
    if (REACT_CORE_PACKAGES.includes(packageName)) {
      const patched = getReactPatchedVersion(version);
      return patched ? { recommended: patched } : null;
    }
    return null;
  },
};
