/**
 * CVE-2025-66478: React2Shell
 * @see https://vercel.com/kb/bulletin/react2shell
 *
 * Affected packages:
 * - next: 14.3.0-canary.77 through various 15.x/16.x versions
 * - react-server-dom-webpack, react-server-dom-parcel, react-server-dom-turbopack: specific 19.x versions
 */

const { parseVersion, compareVersions, cleanVersion } = require('../utils/version');

// Patched versions for Next.js stable releases
const NEXT_PATCHED_VERSIONS = {
  '15.0': '15.0.5',
  '15.1': '15.1.9',
  '15.2': '15.2.6',
  '15.3': '15.3.6',
  '15.4': '15.4.8',
  '15.5': '15.5.7',
  '16.0': '16.0.7',
};

// Patched canary versions for Next.js
const NEXT_CANARY_PATCHES = {
  15: '15.6.0-canary.58',
  16: '16.1.0-canary.12',
};

// Safe versions for 14.x (for this CVE only - 14.x stable is not affected)
const NEXT_14_SAFE_CANARY = '14.3.0-canary.76';

// React RSC versions vulnerable to this CVE and their patches
const REACT_RSC_PATCHES = {
  '19.0.0': '19.0.1',
  '19.1.0': '19.1.2',
  '19.1.1': '19.1.2',
  '19.2.0': '19.2.1',
};

const REACT_RSC_PACKAGES = [
  'react-server-dom-webpack',
  'react-server-dom-parcel',
  'react-server-dom-turbopack',
];

function isNextVulnerable(version) {
  const parsed = parseVersion(version);
  if (!parsed) return { vulnerable: false, reason: 'unparseable' };

  const { major, minor, raw, isCanary } = parsed;

  // Next.js < 14.3.0-canary.77 is not affected by this CVE
  if (major < 14) {
    return { vulnerable: false, reason: 'version-too-old' };
  }

  if (major === 14) {
    if (!isCanary) {
      // Stable 14.x is not affected by this CVE
      return { vulnerable: false, reason: 'stable-14-not-affected' };
    }
    // All 14.x canaries with minor > 3 are vulnerable (they include the vulnerable code from 14.3.0-canary.77+)
    if (minor > 3) {
      return { vulnerable: true, reason: '14.x-canary-after-14.3' };
    }
    // 14.3.0-canary.77+ is vulnerable
    if (minor === 3 && parsed.canary >= 77) {
      return { vulnerable: true, reason: '14.3-canary-77+' };
    }
    return { vulnerable: false, reason: 'canary-before-77' };
  }

  // Next.js 15.x
  if (major === 15) {
    if (isCanary) {
      // 15.6.0-canary.58+ is safe for this CVE
      if (compareVersions(raw, '15.6.0-canary.58') >= 0) {
        return { vulnerable: false, reason: 'patched-canary' };
      }
      return { vulnerable: true, reason: '15.x-canary' };
    }

    // Stable 15.x - check against patched versions
    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (!patchedVersion) {
      // Unknown minor, assume safe if >= 15.6
      return { vulnerable: minor < 6, reason: minor < 6 ? 'unknown-minor-assume-vulnerable' : 'unknown-minor-assume-safe' };
    }

    if (compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }
    return { vulnerable: false, reason: 'patched' };
  }

  // Next.js 16.x
  if (major === 16) {
    if (isCanary) {
      // All 16.x canaries before 16.1.0-canary.12 are vulnerable
      if (compareVersions(raw, '16.1.0-canary.12') < 0) {
        return { vulnerable: true, reason: '16.x-canary' };
      }
      return { vulnerable: false, reason: 'patched-canary' };
    }

    // Stable 16.x
    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (patchedVersion && compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }

    // 16.1+ stable is safe
    if (minor >= 1) {
      return { vulnerable: false, reason: 'patched' };
    }

    // 16.0.x below 16.0.7 is vulnerable
    if (minor === 0 && parsed.patch < 7) {
      return { vulnerable: true, reason: 'below-16.0.7' };
    }

    return { vulnerable: false, reason: 'patched' };
  }

  // Future versions (17+) - assume safe
  return { vulnerable: false, reason: 'future-version' };
}

function isReactRscVulnerable(version) {
  const cleaned = cleanVersion(version);
  return REACT_RSC_PATCHES.hasOwnProperty(cleaned);
}

function getNextPatchedVersion(version) {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const { major, minor, isCanary } = parsed;

  // 14.3.0-canary.77+ special case
  if (major === 14 && isCanary) {
    return {
      recommended: NEXT_14_SAFE_CANARY,
      alternative: '15.0.5',
      note: 'Downgrade to safe canary or upgrade to 15.0.5',
    };
  }

  // Canary versions
  if (isCanary) {
    const canaryPatch = NEXT_CANARY_PATCHES[major];
    if (canaryPatch) {
      return { recommended: canaryPatch };
    }
  }

  // Stable versions
  const minorKey = `${major}.${minor}`;
  const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

  if (patchedVersion) {
    return { recommended: patchedVersion };
  }

  // Fallback for unknown minors
  if (major === 15) return { recommended: '15.5.7' };
  if (major === 16) return { recommended: '16.0.7' };

  return null;
}

function getReactRscPatchedVersion(version) {
  const cleaned = cleanVersion(version);
  return REACT_RSC_PATCHES[cleaned] || null;
}

module.exports = {
  // Metadata
  id: 'CVE-2025-66478',
  name: 'React2Shell',
  severity: 'critical',
  description: 'Remote code execution via crafted RSC payload',

  // Packages this CVE applies to
  packages: ['next', ...REACT_RSC_PACKAGES],

  // Check if a specific package@version is vulnerable
  isVulnerable(packageName, version) {
    if (packageName === 'next') {
      return isNextVulnerable(version);
    }
    if (REACT_RSC_PACKAGES.includes(packageName)) {
      return { vulnerable: isReactRscVulnerable(version), reason: 'rsc-version-check' };
    }
    return { vulnerable: false, reason: 'not-applicable' };
  },

  // Get the minimum version that fixes this CVE
  getPatchedVersion(packageName, version) {
    if (packageName === 'next') {
      return getNextPatchedVersion(version);
    }
    if (REACT_RSC_PACKAGES.includes(packageName)) {
      const patched = getReactRscPatchedVersion(version);
      return patched ? { recommended: patched } : null;
    }
    return null;
  },
};
