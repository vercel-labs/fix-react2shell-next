/**
 * Tests for CVE-2025-66478 (React2Shell) vulnerability detection
 *
 * Affected Next.js versions:
 * - 15.0.0 through 16.0.6
 * - 14 canary versions after 14.3.0-canary.76
 *
 * Patched versions (from the bulletin):
 * | Vulnerable version | Patched release |
 * | Next.js 15.0.x     | 15.0.5          |
 * | Next.js 15.1.x     | 15.1.9          |
 * | Next.js 15.2.x     | 15.2.6          |
 * | Next.js 15.3.x     | 15.3.6          |
 * | Next.js 15.4.x     | 15.4.8          |
 * | Next.js 15.5.x     | 15.5.7          |
 * | Next.js 16.0.x     | 16.0.7          |
 * | 14 canaries after 14.3.0-canary.76 | Downgrade to 14.3.0-canary.76 |
 * | 15 canaries before 15.6.0-canary.58 | 15.6.0-canary.58 |
 * | 16 canaries before 16.1.0-canary.12 | 16.1.0-canary.12 |
 *
 * React RSC packages affected:
 * - react-server-dom-webpack
 * - react-server-dom-parcel
 * - react-server-dom-turbopack
 */

const { describe, it } = require('node:test');
const assert = require('node:assert');
const cve66478 = require('../lib/vulnerabilities/cve-2025-66478');

describe('CVE-2025-66478 (React2Shell)', () => {
  describe('Next.js vulnerability detection', () => {
    describe('versions NOT affected (before 14.3.0-canary.77)', () => {
      const safeVersions = [
        '12.0.0',
        '13.0.0',
        '13.5.0',
        '14.0.0',  // stable 14.x is not affected
        '14.1.0',
        '14.2.0',
        '14.2.33', // latest 14.x stable before any vulnerability
        '14.3.0-canary.0',
        '14.3.0-canary.76', // last safe canary
      ];

      for (const version of safeVersions) {
        it(`should NOT flag ${version} as vulnerable`, () => {
          const result = cve66478.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('versions affected (14.3.0-canary.77 through vulnerable ranges)', () => {
      const vulnerableVersions = [
        '14.3.0-canary.77',  // first vulnerable canary
        '14.3.0-canary.100',
        '14.4.0-canary.0',   // 14.4+ canaries should also be vulnerable
        '14.4.0-canary.50',
        '14.5.0-canary.10',
        '15.0.0',
        '15.0.4',
        '15.1.0',
        '15.1.8',
        '15.2.0',
        '15.2.5',
        '15.3.0',
        '15.3.4',  // mentioned in bulletin example
        '15.3.5',
        '15.4.0',
        '15.4.7',
        '15.5.0',
        '15.5.6',
        '16.0.0',
        '16.0.6',
        '15.6.0-canary.0',
        '15.6.0-canary.57', // one before the patch
        '16.1.0-canary.0',
        '16.1.0-canary.11', // one before the patch
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve66478.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('patched versions (per bulletin)', () => {
      const patchedVersions = [
        '15.0.5',
        '15.1.9',
        '15.2.6',
        '15.3.6',
        '15.4.8',
        '15.5.7',
        '16.0.7',
        '15.6.0-canary.58',
        '15.6.0-canary.100', // after patch
        '16.1.0-canary.12',
        '16.1.0-canary.50',  // after patch
      ];

      for (const version of patchedVersions) {
        it(`should NOT flag ${version} as vulnerable (patched)`, () => {
          const result = cve66478.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable (patched)`);
        });
      }
    });

    describe('versions above patched releases should be safe', () => {
      const safeNewerVersions = [
        '15.0.6',  // one above patch
        '15.1.10',
        '15.2.7',
        '15.3.7',
        '15.4.9',
        '15.5.8',
        '16.0.8',
        '16.1.0',  // stable 16.1 should be safe
        '17.0.0',  // future version
      ];

      for (const version of safeNewerVersions) {
        it(`should NOT flag ${version} as vulnerable`, () => {
          const result = cve66478.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });
  });

  describe('React RSC package vulnerability detection', () => {
    const rscPackages = [
      'react-server-dom-webpack',
      'react-server-dom-parcel',
      'react-server-dom-turbopack',
    ];

    describe('vulnerable React 19 versions', () => {
      // From the bulletin: affected React versions 19.0.0 through 19.2.0
      // Note: 19.0.1, 19.1.2, 19.2.1 are the PATCHED versions for this CVE
      const vulnerableVersions = ['19.0.0', '19.1.0', '19.1.1', '19.2.0'];

      for (const pkg of rscPackages) {
        for (const version of vulnerableVersions) {
          it(`should flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve66478.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, true, `Expected ${pkg}@${version} to be vulnerable`);
          });
        }
      }
    });

    describe('patched React RSC versions', () => {
      // Patched versions for this CVE: 19.0.1, 19.1.2, 19.2.1
      const patchedVersions = ['19.0.1', '19.1.2', '19.2.1'];

      for (const pkg of rscPackages) {
        for (const version of patchedVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve66478.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('getPatchedVersion for React RSC packages', () => {
      it('should recommend 19.0.1 for 19.0.0', () => {
        const result = cve66478.getPatchedVersion('react-server-dom-webpack', '19.0.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.0.1');
      });

      it('should recommend 19.1.2 for 19.1.0', () => {
        const result = cve66478.getPatchedVersion('react-server-dom-webpack', '19.1.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.1.2');
      });

      it('should recommend 19.1.2 for 19.1.1', () => {
        const result = cve66478.getPatchedVersion('react-server-dom-webpack', '19.1.1');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.1.2');
      });

      it('should recommend 19.2.1 for 19.2.0', () => {
        const result = cve66478.getPatchedVersion('react-server-dom-webpack', '19.2.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.2.1');
      });
    });

    describe('React versions before 19 are not affected', () => {
      const safeVersions = ['18.0.0', '18.2.0', '18.3.1'];

      for (const pkg of rscPackages) {
        for (const version of safeVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve66478.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });
  });

  describe('getPatchedVersion recommendations', () => {
    it('should recommend 15.0.5 for 15.0.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.0.4');
      assert.strictEqual(result.recommended, '15.0.5');
    });

    it('should recommend 15.1.9 for 15.1.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.1.0');
      assert.strictEqual(result.recommended, '15.1.9');
    });

    it('should recommend 15.2.6 for 15.2.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.2.0');
      assert.strictEqual(result.recommended, '15.2.6');
    });

    it('should recommend 15.3.6 for 15.3.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.3.4');
      assert.strictEqual(result.recommended, '15.3.6');
    });

    it('should recommend 15.4.8 for 15.4.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.4.0');
      assert.strictEqual(result.recommended, '15.4.8');
    });

    it('should recommend 15.5.7 for 15.5.x', () => {
      const result = cve66478.getPatchedVersion('next', '15.5.0');
      assert.strictEqual(result.recommended, '15.5.7');
    });

    it('should recommend 16.0.7 for 16.0.x', () => {
      const result = cve66478.getPatchedVersion('next', '16.0.0');
      assert.strictEqual(result.recommended, '16.0.7');
    });

    it('should recommend 15.6.0-canary.58 for 15.x canaries', () => {
      const result = cve66478.getPatchedVersion('next', '15.6.0-canary.0');
      assert.strictEqual(result.recommended, '15.6.0-canary.58');
    });

    it('should recommend 16.1.0-canary.12 for 16.x canaries', () => {
      const result = cve66478.getPatchedVersion('next', '16.1.0-canary.0');
      assert.strictEqual(result.recommended, '16.1.0-canary.12');
    });

    it('should recommend downgrade for 14.x canaries after 14.3.0-canary.76', () => {
      const result = cve66478.getPatchedVersion('next', '14.3.0-canary.77');
      assert.strictEqual(result.recommended, '14.3.0-canary.76');
      assert.ok(result.alternative, 'Should have alternative upgrade path');
    });
  });

  describe('edge cases', () => {
    it('should handle version with caret prefix', () => {
      const result = cve66478.isVulnerable('next', '^15.3.4');
      assert.strictEqual(result.vulnerable, true);
    });

    it('should handle version with tilde prefix', () => {
      const result = cve66478.isVulnerable('next', '~15.3.6');
      assert.strictEqual(result.vulnerable, false);
    });

    it('should return not vulnerable for unknown packages', () => {
      const result = cve66478.isVulnerable('react', '19.0.0');
      assert.strictEqual(result.vulnerable, false);
      assert.strictEqual(result.reason, 'not-applicable');
    });

    it('should handle unparseable versions gracefully', () => {
      const result = cve66478.isVulnerable('next', 'invalid');
      assert.strictEqual(result.vulnerable, false);
    });
  });
});
