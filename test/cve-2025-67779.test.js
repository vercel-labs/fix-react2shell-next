/**
 * Tests for CVE-2025-67779 (DoS Incomplete Fix Follow-Up) vulnerability detection
 *
 * Affected packages:
 * - next: 13.x (>= 13.3), 14.x, 15.x, 16.x versions (App Router only)
 * - react-server-dom-webpack: 19.0.2, 19.1.3, 19.2.2
 * - react-server-dom-parcel: 19.0.2, 19.1.3, 19.2.2
 * - react-server-dom-turbopack: 19.0.2, 19.1.3, 19.2.2
 *
 * Patched versions:
 * - Next.js >=13.3 → Upgrade to 14.2.35
 * - Next.js 14.x → 14.2.35
 * - Next.js 15.0.x → 15.0.7
 * - Next.js 15.1.x → 15.1.11
 * - Next.js 15.2.x → 15.2.8
 * - Next.js 15.3.x → 15.3.8
 * - Next.js 15.4.x → 15.4.10
 * - Next.js 15.5.x → 15.5.9
 * - Next.js 15.x canary → 15.6.0-canary.60
 * - Next.js 16.0.x → 16.0.10
 * - Next.js 16.x canary → 16.1.0-canary.19
 * - React Server Components → 19.0.3, 19.1.4, 19.2.3
 *
 * Note: Next.js Pages Router applications are not affected.
 * Note: Incomplete fix follow-up for CVE-2025-55184.
 */

const { describe, it } = require('node:test');
const assert = require('node:assert');
const cve67779 = require('../lib/vulnerabilities/cve-2025-67779');

describe('CVE-2025-67779 (DoS Incomplete Fix Follow-Up)', () => {
  describe('Next.js vulnerability detection', () => {
    describe('versions NOT affected (before App Router - 13.3)', () => {
      const safeVersions = [
        '12.0.0',
        '12.3.4',
        '13.0.0',
        '13.1.0',
        '13.2.0',
        '13.2.9', // last version before App Router
      ];

      for (const version of safeVersions) {
        it(`should NOT flag ${version} as vulnerable (before App Router)`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 13.x (>= 13.3) - vulnerable, must upgrade to 14.2.35', () => {
      const vulnerableVersions = [
        '13.3.0',  // App Router introduced
        '13.4.0',
        '13.5.0',
        '13.5.6',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });

        it(`should recommend 14.2.35 for ${version}`, () => {
          const result = cve67779.getPatchedVersion('next', version);
          assert.strictEqual(result.recommended, '14.2.35');
        });
      }
    });

    describe('Next.js 14.x - vulnerable before 14.2.35', () => {
      const vulnerableVersions = [
        '14.0.0',
        '14.1.0',
        '14.2.0',
        '14.2.34',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }

      it('should NOT flag 14.2.35 as vulnerable (patched)', () => {
        const result = cve67779.isVulnerable('next', '14.2.35');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 14.2.36 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '14.2.36');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 15.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '15.0.0',
        '15.0.6',  // previous patch for DoS, not enough for this follow-up
        '15.1.0',
        '15.1.10', // previous patch for DoS, not enough for this follow-up
        '15.2.0',
        '15.2.7',  // previous patch for DoS, not enough for this follow-up
        '15.3.0',
        '15.3.7',  // previous patch for DoS, not enough for this follow-up
        '15.4.0',
        '15.4.9',  // previous patch for DoS, not enough for this follow-up
        '15.5.0',
        '15.5.8',  // previous patch for DoS, not enough for this follow-up
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x - patched versions', () => {
      const patchedVersions = [
        '15.0.7',
        '15.1.11',
        '15.2.8',
        '15.3.8',
        '15.4.10',
        '15.5.9',
      ];

      for (const version of patchedVersions) {
        it(`should NOT flag ${version} as vulnerable (patched)`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x canaries', () => {
      it('should flag 15.6.0-canary.59 as vulnerable (patch is .60)', () => {
        const result = cve67779.isVulnerable('next', '15.6.0-canary.59');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 15.6.0-canary.60 as vulnerable (patched)', () => {
        const result = cve67779.isVulnerable('next', '15.6.0-canary.60');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 15.6.0-canary.61 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '15.6.0-canary.61');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '16.0.0',
        '16.0.9',  // previous patch for DoS, not enough for this follow-up
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve67779.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 16.x - patched versions', () => {
      it('should NOT flag 16.0.10 as vulnerable (patched)', () => {
        const result = cve67779.isVulnerable('next', '16.0.10');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.0.11 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '16.0.11');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '16.1.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x canaries', () => {
      it('should flag 16.1.0-canary.18 as vulnerable (patch is .19)', () => {
        const result = cve67779.isVulnerable('next', '16.1.0-canary.18');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 16.1.0-canary.19 as vulnerable (patched)', () => {
        const result = cve67779.isVulnerable('next', '16.1.0-canary.19');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0-canary.20 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '16.1.0-canary.20');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Future versions (17+) - assume safe', () => {
      it('should NOT flag 17.0.0 as vulnerable', () => {
        const result = cve67779.isVulnerable('next', '17.0.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });
  });

  describe('React RSC package vulnerability detection', () => {
    const rscPackages = [
      'react-server-dom-webpack',
      'react-server-dom-parcel',
      'react-server-dom-turbopack',
    ];

    describe('vulnerable React 19 versions (19.0.2, 19.1.3, 19.2.2)', () => {
      const vulnerableVersions = [
        '19.0.2',
        '19.1.3',
        '19.2.2',
      ];

      for (const pkg of rscPackages) {
        for (const version of vulnerableVersions) {
          it(`should flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve67779.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, true, `Expected ${pkg}@${version} to be vulnerable`);
          });
        }
      }
    });

    describe('patched React RSC versions', () => {
      const patchedVersions = ['19.0.3', '19.1.4', '19.2.3'];

      for (const pkg of rscPackages) {
        for (const version of patchedVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve67779.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('React versions before 19 are not affected', () => {
      const safeVersions = ['18.0.0', '18.2.0', '18.3.1', '19.0.0', '19.0.1', '19.1.0', '19.1.1', '19.1.2', '19.2.0', '19.2.1'];

      for (const pkg of rscPackages) {
        for (const version of safeVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve67779.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });
  });

  describe('getPatchedVersion recommendations', () => {
    it('should recommend 14.2.35 for 13.x (>= 13.3)', () => {
      const result = cve67779.getPatchedVersion('next', '13.4.0');
      assert.strictEqual(result.recommended, '14.2.35');
    });

    it('should recommend 14.2.35 for 14.x stable', () => {
      const result = cve67779.getPatchedVersion('next', '14.1.0');
      assert.strictEqual(result.recommended, '14.2.35');
    });

    it('should recommend 15.0.7 for 15.0.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.0.0');
      assert.strictEqual(result.recommended, '15.0.7');
    });

    it('should recommend 15.1.11 for 15.1.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.1.0');
      assert.strictEqual(result.recommended, '15.1.11');
    });

    it('should recommend 15.2.8 for 15.2.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.2.0');
      assert.strictEqual(result.recommended, '15.2.8');
    });

    it('should recommend 15.3.8 for 15.3.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.3.0');
      assert.strictEqual(result.recommended, '15.3.8');
    });

    it('should recommend 15.4.10 for 15.4.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.4.0');
      assert.strictEqual(result.recommended, '15.4.10');
    });

    it('should recommend 15.5.9 for 15.5.x', () => {
      const result = cve67779.getPatchedVersion('next', '15.5.0');
      assert.strictEqual(result.recommended, '15.5.9');
    });

    it('should recommend 16.0.10 for 16.0.x', () => {
      const result = cve67779.getPatchedVersion('next', '16.0.0');
      assert.strictEqual(result.recommended, '16.0.10');
    });

    it('should recommend 15.6.0-canary.60 for 15.x canaries', () => {
      const result = cve67779.getPatchedVersion('next', '15.6.0-canary.0');
      assert.strictEqual(result.recommended, '15.6.0-canary.60');
    });

    it('should recommend 16.1.0-canary.19 for 16.x canaries', () => {
      const result = cve67779.getPatchedVersion('next', '16.1.0-canary.0');
      assert.strictEqual(result.recommended, '16.1.0-canary.19');
    });

    describe('React RSC patch recommendations', () => {
      it('should recommend 19.0.3 for 19.0.2', () => {
        const result = cve67779.getPatchedVersion('react-server-dom-webpack', '19.0.2');
        assert.strictEqual(result.recommended, '19.0.3');
      });

      it('should recommend 19.1.4 for 19.1.3', () => {
        const result = cve67779.getPatchedVersion('react-server-dom-webpack', '19.1.3');
        assert.strictEqual(result.recommended, '19.1.4');
      });

      it('should recommend 19.2.3 for 19.2.2', () => {
        const result = cve67779.getPatchedVersion('react-server-dom-webpack', '19.2.2');
        assert.strictEqual(result.recommended, '19.2.3');
      });
    });
  });

  describe('metadata', () => {
    it('should have correct CVE ID', () => {
      assert.strictEqual(cve67779.id, 'CVE-2025-67779');
    });

    it('should have high severity', () => {
      assert.strictEqual(cve67779.severity, 'high');
    });

    it('should include all relevant packages', () => {
      assert.ok(cve67779.packages.includes('next'));
      assert.ok(cve67779.packages.includes('react-server-dom-webpack'));
      assert.ok(cve67779.packages.includes('react-server-dom-parcel'));
      assert.ok(cve67779.packages.includes('react-server-dom-turbopack'));
    });
  });
});
