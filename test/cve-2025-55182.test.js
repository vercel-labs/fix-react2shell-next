/**
 * Tests for CVE-2025-55182 (React Core Security Issue)
 *
 * Affected packages:
 * - react: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 * - react-dom: 19.0.0, 19.1.0, 19.1.1, 19.2.0
 *
 * Patched versions:
 * - 19.0.0 → 19.0.1
 * - 19.1.0 → 19.1.2
 * - 19.1.1 → 19.1.2
 * - 19.2.0 → 19.2.1
 */

const { describe, it } = require('node:test');
const assert = require('node:assert');
const cve55182 = require('../lib/vulnerabilities/cve-2025-55182');

describe('CVE-2025-55182 (React Core Security Issue)', () => {
  describe('React package vulnerability detection', () => {
    const reactPackages = ['react', 'react-dom'];

    describe('vulnerable React 19 versions', () => {
      const vulnerableVersions = ['19.0.0', '19.1.0', '19.1.1', '19.2.0'];

      for (const pkg of reactPackages) {
        for (const version of vulnerableVersions) {
          it(`should flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55182.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, true, `Expected ${pkg}@${version} to be vulnerable`);
          });
        }
      }
    });

    describe('patched React versions', () => {
      const patchedVersions = ['19.0.1', '19.1.2', '19.2.1'];

      for (const pkg of reactPackages) {
        for (const version of patchedVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55182.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('React versions before 19 are not affected', () => {
      const safeVersions = ['18.0.0', '18.2.0', '18.3.1'];

      for (const pkg of reactPackages) {
        for (const version of safeVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55182.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('getPatchedVersion recommendations', () => {
      it('should recommend 19.0.1 for react@19.0.0', () => {
        const result = cve55182.getPatchedVersion('react', '19.0.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.0.1');
      });

      it('should recommend 19.1.2 for react@19.1.0', () => {
        const result = cve55182.getPatchedVersion('react', '19.1.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.1.2');
      });

      it('should recommend 19.1.2 for react@19.1.1', () => {
        const result = cve55182.getPatchedVersion('react', '19.1.1');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.1.2');
      });

      it('should recommend 19.2.1 for react@19.2.0', () => {
        const result = cve55182.getPatchedVersion('react', '19.2.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.2.1');
      });

      it('should work for react-dom as well', () => {
        const result = cve55182.getPatchedVersion('react-dom', '19.0.0');
        assert.ok(result, 'Should return a patch recommendation');
        assert.strictEqual(result.recommended, '19.0.1');
      });
    });

    describe('edge cases', () => {
      it('should handle version with caret prefix', () => {
        const result = cve55182.isVulnerable('react', '^19.0.0');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should handle version with tilde prefix', () => {
        const result = cve55182.isVulnerable('react', '~19.0.1');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should return not vulnerable for unknown packages', () => {
        const result = cve55182.isVulnerable('next', '19.0.0');
        assert.strictEqual(result.vulnerable, false);
        assert.strictEqual(result.reason, 'not-applicable');
      });

      it('should handle unparseable versions gracefully', () => {
        const result = cve55182.isVulnerable('react', 'invalid');
        assert.strictEqual(result.vulnerable, false);
      });
    });
  });
});
