/**
 * Tests for CVE-2025-55184 (Denial of Service) vulnerability detection
 *
 * These vulnerabilities affect React versions 19.0.0 through 19.2.1
 * and Next.js versions 13.x through 16.x.
 *
 * Affected versions (DoS):
 * - Next.js >= 13.3 (App Router introduced)
 * - Next.js 14.x
 * - Next.js 15.0.x through 15.5.x
 * - Next.js 16.0.x
 *
 * Patched versions (from the bulletin):
 * | Version              | Fixed In              |
 * | Next.js >=13.3       | Upgrade to 14.2.34    |
 * | Next.js 14.x         | 14.2.34               |
 * | Next.js 15.0.x       | 15.0.6                |
 * | Next.js 15.1.x       | 15.1.10               |
 * | Next.js 15.2.x       | 15.2.7                |
 * | Next.js 15.3.x       | 15.3.7                |
 * | Next.js 15.4.x       | 15.4.9                |
 * | Next.js 15.5.x       | 15.5.8                |
 * | Next.js 15.x canary  | 15.6.0-canary.59      |
 * | Next.js 16.0.x       | 16.0.9                |
 * | Next.js 16.0.x canary| 16.1.0-canary.18      |
 *
 * Note: Pages Router applications are not affected.
 */

const { describe, it } = require('node:test');
const assert = require('node:assert');
const cve55184 = require('../lib/vulnerabilities/cve-2025-55184');

describe('CVE-2025-55184 (Denial of Service)', () => {
  describe('Next.js vulnerability detection', () => {
    describe('versions NOT affected (before App Router - 13.3)', () => {
      const safeVersions = [
        '12.0.0',
        '12.3.4',
        '13.0.0',
        '13.1.0',
        '13.2.0',
        '13.2.9', // last version before App Router
      ];

      for (const version of safeVersions) {
        it(`should NOT flag ${version} as vulnerable (before App Router)`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 13.x (>= 13.3) - vulnerable, must upgrade to 14.2.34', () => {
      const vulnerableVersions = [
        '13.3.0',  // App Router introduced
        '13.4.0',
        '13.5.0',
        '13.5.6',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });

        it(`should recommend 14.2.34 for ${version}`, () => {
          const result = cve55184.getPatchedVersion('next', version);
          assert.strictEqual(result.recommended, '14.2.34');
        });
      }
    });

    describe('Next.js 14.x - vulnerable before 14.2.34', () => {
      const vulnerableVersions = [
        '14.0.0',
        '14.1.0',
        '14.2.0',
        '14.2.33',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }

      it('should NOT flag 14.2.34 as vulnerable (patched)', () => {
        const result = cve55184.isVulnerable('next', '14.2.34');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 14.2.35 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '14.2.35');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 14.x canaries - all vulnerable (no patch available per bulletin)', () => {
      const vulnerableCanaries = [
        '14.3.0-canary.0',
        '14.3.0-canary.76',
        '14.3.0-canary.77',
        '14.3.0-canary.100',
      ];

      for (const version of vulnerableCanaries) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '15.0.0',
        '15.0.5',  // previous patch for React2Shell, not enough for DoS
        '15.1.0',
        '15.1.9',  // previous patch for React2Shell, not enough for DoS
        '15.2.0',
        '15.2.6',  // previous patch for React2Shell, not enough for DoS
        '15.3.0',
        '15.3.6',  // previous patch for React2Shell, not enough for DoS
        '15.4.0',
        '15.4.8',  // previous patch for React2Shell, not enough for DoS
        '15.5.0',
        '15.5.7',  // previous patch for React2Shell, not enough for DoS
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x - patched versions (per new bulletin)', () => {
      const patchedVersions = [
        '15.0.6',
        '15.1.10',
        '15.2.7',
        '15.3.7',
        '15.4.9',
        '15.5.8',
      ];

      for (const version of patchedVersions) {
        it(`should NOT flag ${version} as vulnerable (patched)`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x canaries', () => {
      it('should flag 15.6.0-canary.58 as vulnerable (patch is .59)', () => {
        const result = cve55184.isVulnerable('next', '15.6.0-canary.58');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 15.6.0-canary.59 as vulnerable (patched)', () => {
        const result = cve55184.isVulnerable('next', '15.6.0-canary.59');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 15.6.0-canary.60 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '15.6.0-canary.60');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '16.0.0',
        '16.0.7',  // previous patch for React2Shell, not enough for DoS
        '16.0.8',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55184.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 16.x - patched versions', () => {
      it('should NOT flag 16.0.9 as vulnerable (patched)', () => {
        const result = cve55184.isVulnerable('next', '16.0.9');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.0.10 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '16.0.10');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '16.1.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x canaries', () => {
      it('should flag 16.1.0-canary.12 as vulnerable (patch is .18)', () => {
        const result = cve55184.isVulnerable('next', '16.1.0-canary.12');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should flag 16.1.0-canary.17 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '16.1.0-canary.17');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 16.1.0-canary.18 as vulnerable (patched)', () => {
        const result = cve55184.isVulnerable('next', '16.1.0-canary.18');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0-canary.20 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '16.1.0-canary.20');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Future versions (17+) - assume safe', () => {
      it('should NOT flag 17.0.0 as vulnerable', () => {
        const result = cve55184.isVulnerable('next', '17.0.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });
  });

  describe('React RSC package vulnerability detection', () => {
    const rscPackages = [
      'react-server-dom-webpack',
      'react-server-dom-parcel',
      'react-server-dom-turbopack',
    ];

    describe('vulnerable React 19 versions (19.0.0 through 19.2.1 per bulletin)', () => {
      const vulnerableVersions = [
        '19.0.0',
        '19.0.1',
        '19.1.0',
        '19.1.1',
        '19.1.2',
        '19.2.0',
        '19.2.1',
      ];

      for (const pkg of rscPackages) {
        for (const version of vulnerableVersions) {
          it(`should flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55184.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, true, `Expected ${pkg}@${version} to be vulnerable`);
          });
        }
      }
    });

    describe('patched React RSC versions', () => {
      const patchedVersions = ['19.0.2', '19.1.3', '19.2.2'];

      for (const pkg of rscPackages) {
        for (const version of patchedVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55184.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('React versions before 19 are not affected', () => {
      const safeVersions = ['18.0.0', '18.2.0', '18.3.1'];

      for (const pkg of rscPackages) {
        for (const version of safeVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55184.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });
  });

  describe('getPatchedVersion recommendations', () => {
    it('should recommend 14.2.34 for 13.x (>= 13.3)', () => {
      const result = cve55184.getPatchedVersion('next', '13.4.0');
      assert.strictEqual(result.recommended, '14.2.34');
    });

    it('should recommend 14.2.34 for 14.x stable', () => {
      const result = cve55184.getPatchedVersion('next', '14.1.0');
      assert.strictEqual(result.recommended, '14.2.34');
    });

    it('should recommend 15.0.6 for 15.0.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.0.0');
      assert.strictEqual(result.recommended, '15.0.6');
    });

    it('should recommend 15.1.10 for 15.1.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.1.0');
      assert.strictEqual(result.recommended, '15.1.10');
    });

    it('should recommend 15.2.7 for 15.2.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.2.0');
      assert.strictEqual(result.recommended, '15.2.7');
    });

    it('should recommend 15.3.7 for 15.3.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.3.0');
      assert.strictEqual(result.recommended, '15.3.7');
    });

    it('should recommend 15.4.9 for 15.4.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.4.0');
      assert.strictEqual(result.recommended, '15.4.9');
    });

    it('should recommend 15.5.8 for 15.5.x', () => {
      const result = cve55184.getPatchedVersion('next', '15.5.0');
      assert.strictEqual(result.recommended, '15.5.8');
    });

    it('should recommend 16.0.9 for 16.0.x', () => {
      const result = cve55184.getPatchedVersion('next', '16.0.0');
      assert.strictEqual(result.recommended, '16.0.9');
    });

    it('should recommend 15.6.0-canary.59 for 15.x canaries', () => {
      const result = cve55184.getPatchedVersion('next', '15.6.0-canary.0');
      assert.strictEqual(result.recommended, '15.6.0-canary.59');
    });

    it('should recommend 16.1.0-canary.18 for 16.x canaries', () => {
      const result = cve55184.getPatchedVersion('next', '16.1.0-canary.0');
      assert.strictEqual(result.recommended, '16.1.0-canary.18');
    });

    describe('React RSC patch recommendations', () => {
      it('should recommend 19.0.2 for 19.0.x', () => {
        const result = cve55184.getPatchedVersion('react-server-dom-webpack', '19.0.0');
        assert.strictEqual(result.recommended, '19.0.2');
      });

      it('should recommend 19.1.3 for 19.1.x', () => {
        const result = cve55184.getPatchedVersion('react-server-dom-webpack', '19.1.0');
        assert.strictEqual(result.recommended, '19.1.3');
      });

      it('should recommend 19.2.2 for 19.2.x', () => {
        const result = cve55184.getPatchedVersion('react-server-dom-webpack', '19.2.0');
        assert.strictEqual(result.recommended, '19.2.2');
      });
    });
  });

  describe('metadata', () => {
    it('should have correct CVE ID', () => {
      assert.strictEqual(cve55184.id, 'CVE-2025-55184');
    });

    it('should have high severity', () => {
      assert.strictEqual(cve55184.severity, 'high');
    });

    it('should include all relevant packages', () => {
      assert.ok(cve55184.packages.includes('next'));
      assert.ok(cve55184.packages.includes('react-server-dom-webpack'));
      assert.ok(cve55184.packages.includes('react-server-dom-parcel'));
      assert.ok(cve55184.packages.includes('react-server-dom-turbopack'));
    });
  });
});
