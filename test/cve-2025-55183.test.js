/**
 * Tests for CVE-2025-55183 (Source Code Exposure) vulnerability detection
 *
 * Source Code Exposure affects ONLY Next.js 15.x and 16.x (NOT 13.x or 14.x).
 *
 * Affected versions:
 * - Next.js 15.0.x before 15.0.6
 * - Next.js 15.1.x before 15.1.10
 * - Next.js 15.2.x before 15.2.7
 * - Next.js 15.3.x before 15.3.7
 * - Next.js 15.4.x before 15.4.9
 * - Next.js 15.5.x before 15.5.8
 * - Next.js 15.x canary before 15.6.0-canary.59
 * - Next.js 16.0.x before 16.0.9
 * - Next.js 16.x canary before 16.1.0-canary.17
 * - React RSC packages 19.0.0 through 19.2.1
 *
 * Note: Next.js 13.x and 14.x are NOT affected by this CVE (per bulletin table).
 * Note: Pages Router applications are not affected.
 */

const { describe, it } = require('node:test');
const assert = require('node:assert');
const cve55183 = require('../lib/vulnerabilities/cve-2025-55183');

describe('CVE-2025-55183 (Source Code Exposure)', () => {
  describe('Next.js vulnerability detection', () => {
    describe('versions NOT affected (13.x and 14.x per bulletin)', () => {
      const notAffectedVersions = [
        '12.0.0',
        '13.0.0',
        '13.3.0',
        '13.4.0',
        '13.5.6',
        '14.0.0',
        '14.1.0',
        '14.2.0',
        '14.2.34',
        '14.3.0-canary.76',
        '14.3.0-canary.77',
      ];

      for (const version of notAffectedVersions) {
        it(`should NOT flag ${version} as vulnerable (13.x/14.x not affected)`, () => {
          const result = cve55183.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '15.0.0',
        '15.0.5',
        '15.1.0',
        '15.1.9',
        '15.2.0',
        '15.2.6',
        '15.3.0',
        '15.3.6',
        '15.4.0',
        '15.4.8',
        '15.5.0',
        '15.5.7',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55183.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x - patched versions', () => {
      const patchedVersions = [
        '15.0.6',
        '15.1.10',
        '15.2.7',
        '15.3.7',
        '15.4.9',
        '15.5.8',
      ];

      for (const version of patchedVersions) {
        it(`should NOT flag ${version} as vulnerable (patched)`, () => {
          const result = cve55183.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, false, `Expected ${version} to NOT be vulnerable`);
        });
      }
    });

    describe('Next.js 15.x canaries', () => {
      it('should flag 15.6.0-canary.57 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '15.6.0-canary.57');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should flag 15.6.0-canary.58 as vulnerable (patch is .59)', () => {
        const result = cve55183.isVulnerable('next', '15.6.0-canary.58');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 15.6.0-canary.59 as vulnerable (patched)', () => {
        const result = cve55183.isVulnerable('next', '15.6.0-canary.59');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 15.6.0-canary.60 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '15.6.0-canary.60');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x - vulnerable versions', () => {
      const vulnerableVersions = [
        '16.0.0',
        '16.0.7',
        '16.0.8',
      ];

      for (const version of vulnerableVersions) {
        it(`should flag ${version} as vulnerable`, () => {
          const result = cve55183.isVulnerable('next', version);
          assert.strictEqual(result.vulnerable, true, `Expected ${version} to be vulnerable`);
        });
      }
    });

    describe('Next.js 16.x - patched versions', () => {
      it('should NOT flag 16.0.9 as vulnerable (patched)', () => {
        const result = cve55183.isVulnerable('next', '16.0.9');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.0.10 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '16.0.10');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '16.1.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Next.js 16.x canaries', () => {
      it('should flag 16.1.0-canary.12 as vulnerable (patch is .17)', () => {
        const result = cve55183.isVulnerable('next', '16.1.0-canary.12');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should flag 16.1.0-canary.17 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '16.1.0-canary.17');
        assert.strictEqual(result.vulnerable, true);
      });

      it('should NOT flag 16.1.0-canary.18 as vulnerable (patched)', () => {
        const result = cve55183.isVulnerable('next', '16.1.0-canary.18');
        assert.strictEqual(result.vulnerable, false);
      });

      it('should NOT flag 16.1.0-canary.20 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '16.1.0-canary.20');
        assert.strictEqual(result.vulnerable, false);
      });
    });

    describe('Future versions (17+) - assume safe', () => {
      it('should NOT flag 17.0.0 as vulnerable', () => {
        const result = cve55183.isVulnerable('next', '17.0.0');
        assert.strictEqual(result.vulnerable, false);
      });
    });
  });

  describe('React RSC package vulnerability detection', () => {
    const rscPackages = [
      'react-server-dom-webpack',
      'react-server-dom-parcel',
      'react-server-dom-turbopack',
    ];

    describe('vulnerable React 19 versions (19.0.0 through 19.2.1 per bulletin)', () => {
      const vulnerableVersions = [
        '19.0.0',
        '19.0.1',
        '19.1.0',
        '19.1.1',
        '19.1.2',
        '19.2.0',
        '19.2.1',
      ];

      for (const pkg of rscPackages) {
        for (const version of vulnerableVersions) {
          it(`should flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55183.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, true, `Expected ${pkg}@${version} to be vulnerable`);
          });
        }
      }
    });

    describe('patched React RSC versions', () => {
      const patchedVersions = ['19.0.2', '19.1.3', '19.2.2'];

      for (const pkg of rscPackages) {
        for (const version of patchedVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55183.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });

    describe('React versions before 19 are not affected', () => {
      const safeVersions = ['18.0.0', '18.2.0', '18.3.1'];

      for (const pkg of rscPackages) {
        for (const version of safeVersions) {
          it(`should NOT flag ${pkg}@${version} as vulnerable`, () => {
            const result = cve55183.isVulnerable(pkg, version);
            assert.strictEqual(result.vulnerable, false, `Expected ${pkg}@${version} to NOT be vulnerable`);
          });
        }
      }
    });
  });

  describe('getPatchedVersion recommendations', () => {
    it('should return null for 13.x (not affected)', () => {
      const result = cve55183.getPatchedVersion('next', '13.4.0');
      assert.strictEqual(result, null);
    });

    it('should return null for 14.x (not affected)', () => {
      const result = cve55183.getPatchedVersion('next', '14.2.0');
      assert.strictEqual(result, null);
    });

    it('should recommend 15.0.6 for 15.0.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.0.0');
      assert.strictEqual(result.recommended, '15.0.6');
    });

    it('should recommend 15.1.10 for 15.1.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.1.0');
      assert.strictEqual(result.recommended, '15.1.10');
    });

    it('should recommend 15.2.7 for 15.2.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.2.0');
      assert.strictEqual(result.recommended, '15.2.7');
    });

    it('should recommend 15.3.7 for 15.3.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.3.0');
      assert.strictEqual(result.recommended, '15.3.7');
    });

    it('should recommend 15.4.9 for 15.4.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.4.0');
      assert.strictEqual(result.recommended, '15.4.9');
    });

    it('should recommend 15.5.8 for 15.5.x', () => {
      const result = cve55183.getPatchedVersion('next', '15.5.0');
      assert.strictEqual(result.recommended, '15.5.8');
    });

    it('should recommend 16.0.9 for 16.0.x', () => {
      const result = cve55183.getPatchedVersion('next', '16.0.0');
      assert.strictEqual(result.recommended, '16.0.9');
    });

    it('should recommend 15.6.0-canary.59 for 15.x canaries', () => {
      const result = cve55183.getPatchedVersion('next', '15.6.0-canary.0');
      assert.strictEqual(result.recommended, '15.6.0-canary.59');
    });

    it('should recommend 16.1.0-canary.18 for 16.x canaries', () => {
      const result = cve55183.getPatchedVersion('next', '16.1.0-canary.0');
      assert.strictEqual(result.recommended, '16.1.0-canary.18');
    });

    describe('React RSC patch recommendations', () => {
      it('should recommend 19.0.2 for 19.0.x', () => {
        const result = cve55183.getPatchedVersion('react-server-dom-webpack', '19.0.0');
        assert.strictEqual(result.recommended, '19.0.2');
      });

      it('should recommend 19.1.3 for 19.1.x', () => {
        const result = cve55183.getPatchedVersion('react-server-dom-webpack', '19.1.0');
        assert.strictEqual(result.recommended, '19.1.3');
      });

      it('should recommend 19.2.2 for 19.2.x', () => {
        const result = cve55183.getPatchedVersion('react-server-dom-webpack', '19.2.0');
        assert.strictEqual(result.recommended, '19.2.2');
      });
    });
  });

  describe('metadata', () => {
    it('should have correct CVE ID', () => {
      assert.strictEqual(cve55183.id, 'CVE-2025-55183');
    });

    it('should have medium severity', () => {
      assert.strictEqual(cve55183.severity, 'medium');
    });

    it('should include all relevant packages', () => {
      assert.ok(cve55183.packages.includes('next'));
      assert.ok(cve55183.packages.includes('react-server-dom-webpack'));
      assert.ok(cve55183.packages.includes('react-server-dom-parcel'));
      assert.ok(cve55183.packages.includes('react-server-dom-turbopack'));
    });
  });

  describe('comparison with CVE-2025-55184 (DoS)', () => {
    const cve55184 = require('../lib/vulnerabilities/cve-2025-55184');

    it('13.x should be vulnerable to DoS but NOT Source Code Exposure', () => {
      const dosResult = cve55184.isVulnerable('next', '13.4.0');
      const sceResult = cve55183.isVulnerable('next', '13.4.0');

      assert.strictEqual(dosResult.vulnerable, true, '13.x should be vulnerable to DoS');
      assert.strictEqual(sceResult.vulnerable, false, '13.x should NOT be vulnerable to Source Code Exposure');
    });

    it('14.x should be vulnerable to DoS but NOT Source Code Exposure', () => {
      const dosResult = cve55184.isVulnerable('next', '14.2.0');
      const sceResult = cve55183.isVulnerable('next', '14.2.0');

      assert.strictEqual(dosResult.vulnerable, true, '14.x should be vulnerable to DoS');
      assert.strictEqual(sceResult.vulnerable, false, '14.x should NOT be vulnerable to Source Code Exposure');
    });

    it('15.x vulnerable version should be vulnerable to both CVEs', () => {
      const dosResult = cve55184.isVulnerable('next', '15.3.0');
      const sceResult = cve55183.isVulnerable('next', '15.3.0');

      assert.strictEqual(dosResult.vulnerable, true, '15.x should be vulnerable to DoS');
      assert.strictEqual(sceResult.vulnerable, true, '15.x should be vulnerable to Source Code Exposure');
    });
  });
});
